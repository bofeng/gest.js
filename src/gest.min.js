window.gest=function(e){"use strict";navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var t={framerate:25,videoCompressionRate:4,sensitivity:80,skinFilter:false,debug:{state:false,canvas:null,context:null}},a=false,n=false,i,s,r,o,d=function(){if(d.prototype._singletonInstance){return d.prototype._singletonInstance}d.prototype._singletonInstance=this;if(document.readyState==="complete"){t.call()}else{b.addEventListener("DOMContentLoaded",document,t);b.addEventListener("load",e,t)}function t(){b.removeEventListener("DOMContentLoaded",document,t);b.removeEventListener("load",e,t);if(l()){a=true}if(n&&a){return e.gest.start()}return false}return true},c=function(e){var t=b.createCustomEvent("gest",document);t.direction=e.direction||null;t.up=e.up||false;t.down=e.down||false;t.left=e.left||false;t.right=e.right||false;t.error=e.error||null;b.fireEvent(t)},l=function(){s=document.createElement("video");r=document.createElement("canvas");if(!!s.canPlayType&&!!(r.getContext&&r.getContext("2d"))&&!!navigator.getUserMedia){s.width=300;s.height=225;s.setAttribute("style","visibility:hidden;position:absolute;bottom:0;right:0");document.body.appendChild(s);r.setAttribute("style","width: 300px; display: none;");document.body.appendChild(r);o=r.getContext("2d")}else{f(0);return false}return true},u=function(){if(s){s.parentNode.removeChild(s)}if(r){r.parentNode.removeChild(r)}},f=function(e,a){var n;switch(e){case 0:n={code:e,message:"gest.js can't run in your browser :("};break;case 1:n={code:e,message:"gest.js could not start."};break;case 2:n={code:e,message:"gest.js has already started."};break;case 10:n={code:e,message:"DEEENIED! gest.js needs webcam access.",obj:a};break;case 11:n={code:e,message:"A constraint specified is not supported by the web-browser.",obj:a};break;case 12:n={code:e,message:"No media tracks of the type specified in the constraints are found.",obj:a};break;case 13:n={code:e,message:"Couldn't get access to webcam.",obj:a};break;default:n=null;break}if(t.debug.state){console.error(n.message)}c({error:n})},h=function(e,a){try{o.drawImage(s,0,0,e,a);var n=o.getImageData(0,0,e,a);if(t.skinFilter){g.get(v.apply(n),t.sensitivity,e,a)}else{g.get(n,t.sensitivity,e,a)}}catch(e){if(e.name==="NS_ERROR_NOT_AVAILABLE"){return false}else{throw e}}},v={huemin:0,huemax:.1,satmin:.3,satmax:1,valmin:.4,valmax:1,rgb2hsv:function(e,t,a){e=e/255;t=t/255;a=a/255;var n=Math.max(e,t,a),i=Math.min(e,t,a),s,r,o=n,d=n-i;if(n===0){r=0}else{r=d/n}if(n==i){s=0}else{switch(n){case e:s=(t-a)/d+(t<a?6:0);break;case t:s=(a-e)/d+2;break;case a:s=(e-t)/d+4;break;default:break}s/=6}return[s,r,o]},apply:function(e){var t=e.width*e.height,a=t*4,n=0;for(var i=0;i<e.height;i++){for(var s=0;s<e.width;s++){a=s+i*e.width;var r=e.data[n],o=e.data[n+1],d=e.data[n+2],c=e.data[n+3],l=this.rgb2hsv(r,o,d);if((l[0]>this.huemin&&l[0]<this.huemax||l[0]>.59&&l[0]<1)&&(l[1]>this.satmin&&l[1]<this.satmax)&&(l[2]>this.valmin&&l[2]<this.valmax)){e[n]=r;e[n+1]=o;e[n+2]=d;e[n+3]=c}else{e.data[n]=255;e.data[n+1]=255;e.data[n+2]=255;e.data[n+3]=0}n=a*4}}return e}},g={priorFrame:false,get:function(e,a,n,i){var s=o.createImageData(n,i),r=0,d=0,c=0;if(this.priorFrame!==false){var l=s.width*s.height,u=l*4,f=256*3;while((u-=4)>=0){var h=Math.abs(e.data[u]-this.priorFrame.data[u])+Math.abs(e.data[u+1]-this.priorFrame.data[u+1])+Math.abs(e.data[u+2]-this.priorFrame.data[u+2]);if(h>f*Math.abs((a-100)/100)){s.data[u]=255;s.data[u+1]=0;s.data[u+2]=0;s.data[u+3]=255;c+=1;r+=u/4%s.width;d+=Math.floor(u/4/s.height)}else{s.data[u]=e.data[u];s.data[u+1]=e.data[u+1];s.data[u+2]=e.data[u+2];s.data[u+3]=e.data[u+3]}}}if(c>0){m.search({x:r,y:d,d:c});if(t.debug.state&&t.debug.context.putImageData){t.debug.canvas.width=n;t.debug.canvas.height=i;t.debug.context.putImageData(s,0,0)}}this.priorFrame=e}},m={prior:false,filteringFactor:.9,filteredTotal:0,minTotalChange:300,minDirChange:2,longDirChange:7,state:0,search:function(e){var t={x:e.x/e.d,y:e.y/e.d,d:e.d};this.filteredTotal=this.filteringFactor*this.filteredTotal+(1-this.filteringFactor)*t.d;var a=t.d-this.filteredTotal,n=a>this.minTotalChange;switch(this.state){case 0:if(n){this.state=1;m.prior=t}break;case 1:this.state=2;var i=t.x-m.prior.x,s=t.y-m.prior.y,r=Math.abs(s)<Math.abs(i);if(i<-this.minDirChange&&r){c({direction:"Right",right:true})}else if(i>this.minDirChange&&r){c({direction:"Left",left:true})}if(s>this.minDirChange&&!r){if(Math.abs(s)>this.longDirChange){c({direction:"Long down",down:true})}else{c({direction:"Down",down:true})}}else if(s<-this.minDirChange&&!r){if(Math.abs(s)>this.longDirChange){c({direction:"Long up",up:true})}else{c({direction:"Up",up:true})}}break;case 2:if(!n){this.state=0}break;default:break}}},b={htmlEvents:{onload:1,onunload:1,onblur:1,onchange:1,onfocus:1,onreset:1,onselect:1,onsubmit:1,onabort:1,onkeydown:1,onkeypress:1,onkeyup:1,onclick:1,ondblclick:1,onmousedown:1,onmousemove:1,onmouseout:1,onmouseover:1,onmouseup:1},addEventListener:function(e,t,a){if(t.addEventListener)t.addEventListener(e,a,false);else if(t.attachEvent&&this.htmlEvents["on"+e]){t.attachEvent("on"+e,a)}else{t["on"+e]=a}},removeEventListener:function(e,t,a){if(t.removeEventListener)t.removeEventListener(e,a,false);else if(t.detachEvent&&this.htmlEvents["on"+e]){t.detachEvent("on"+e,a)}else{t["on"+e]=null}},createCustomEvent:function(e,t){try{var a;if(t.createEvent){a=t.createEvent("Event");a.initEvent(e,true,true)}else if(t.createEventObject){a=t.createEventObject();a.eventType=e}a.evntName=e;a.evntElement=t;return a}catch(e){console.error(e);return false}},fireEvent:function(e){try{if(e.evntElement.dispatchEvent){e.evntElement.dispatchEvent(e)}else if(e.evntElement.fireEvent&&this.htmlEvents["on"+e.evntName]){e.evntElement.fireEvent("on"+e.eventType,e)}else if(e.evntElement[e.evntName]){e.evntElement[e.evntName]()}else if(e.evntElement["on"+e.evntName]){e.evntElement["on"+e.evntName]()}}catch(e){console.error(e)}}};d.prototype.start=function(){n=true;if(!a){return false}if(!s||!(s.paused||s.ended||s.seeking||s.readyState<s.HAVE_FUTURE_DATA)){f(2);return false}navigator.getUserMedia({audio:false,video:true},function(a){i=a;e.URL=e.URL||e.webkitURL;if("srcObject"in s){s.srcObject=i}else{s.src=e.URL.createObjectURL(i)}b.addEventListener("canplaythrough",s,function(){s.play();b.addEventListener("playing",s,function(){var e=Math.floor(s.getBoundingClientRect().width/t.videoCompressionRate),a=Math.floor(s.getBoundingClientRect().height/t.videoCompressionRate);r.width=e;r.height=a;setInterval(function(){h(e,a)},1e3/t.framerate)})})},function(e){if(e.PERMISSION_DENIED||e.name==="PERMISSION_DENIED"){f(10,e)}else if(e.NOT_SUPPORTED_ERROR||e.name==="NOT_SUPPORTED_ERROR"){f(11,e)}else if(e.MANDATORY_UNSATISFIED_ERROR||e.name==="MANDATORY_UNSATISFIED_ERROR"){f(12,e)}else{f(13,e)}});return!!navigator.getUserMedia};d.prototype.stop=function(){if(!a||!n){return false}u();l();if(!i)return false;if(i.stop){i.stop()}if(i.getTracks){var e=i.getTracks();e.forEach(function(e){e.stop()})}return true};d.prototype._cbks=[];d.prototype.unsubscribeAllCallback=function(){d.prototype._cbks.forEach(function(e){b.removeEventListener("gest",document,e)})};d.prototype.options={subscribeWithCallback:function(e){if(e){var t=function(t){e(t)};d.prototype._cbks.push(t);b.addEventListener("gest",document,t)}},sensitivity:function(e){if(e>=100){t.sensitivity=100}else if(e<=0){t.sensitivity=0}else{t.sensitivity=e}},debug:function(e){t.debug.state=e;if(e){t.debug.canvas=document.createElement("canvas");t.debug.canvas.setAttribute("style","width: 100%; height: 100%; display: block; position: absolute; top: 0; left: 0;");document.body.appendChild(t.debug.canvas);t.debug.context=t.debug.canvas.getContext("2d")}else{t.debug.canvas.setAttribute("style","display: none;");t.debug.canvas.parentNode.removeChild(t.debug.canvas)}return t.debug},skinFilter:function(e){t.skinFilter=e}};return new d}(window);